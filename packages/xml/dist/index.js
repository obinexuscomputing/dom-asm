class t{stateNodes=[];nodeMap=new Map;optimize(t){this.initializeStructure(t.root);const e=this.buildEquivalenceClasses(),n=this.buildMinimizedAST(e);return n.metadata=this.computeMetadata(n.root),n}initializeStructure(t){if(this.nodeMap.has(t))return this.nodeMap.get(t);const e={type:t.type,value:t.value,transitions:new Map,astChildren:new Set,equivalenceClass:0};if(this.nodeMap.set(t,e),this.stateNodes.push(e),t.children)for(const n of t.children){const t=this.initializeStructure(n);e.astChildren.add(n),"Element"===n.type&&e.transitions.set(n.name,t)}return e}buildEquivalenceClasses(){let t=new Map,e=0;const n=new Map;for(const t of this.stateNodes){const e=this.computeInitialSignature(t);n.has(e)||n.set(e,new Set),n.get(e).add(t)}for(const i of n.values()){t.set(e,i);for(const t of i)t.equivalenceClass=e;e++}let i=!0;for(;i;){i=!1;const e=new Map;let n=0;for(const[,s]of t){const t=this.splitByTransitions(s);if(t.size>1){i=!0;for(const i of t.values()){e.set(n,i);for(const t of i)t.equivalenceClass=n;n++}}else{e.set(n,s);for(const t of s)t.equivalenceClass=n;n++}}t=e}return t}computeInitialSignature(t){return`${t.type}:${t.value||""}:${t.transitions.size}`}splitByTransitions(t){const e=new Map;for(const n of t){const t=this.computeTransitionSignature(n);e.has(t)||e.set(t,new Set),e.get(t).add(n)}return e}computeTransitionSignature(t){const e=[];for(const[n,i]of t.transitions)e.push(`${n}:${i.equivalenceClass}`);for(const n of t.astChildren){const t=this.nodeMap.get(n);t&&e.push(`child:${t.equivalenceClass}`)}return e.sort().join("|")}buildMinimizedAST(t){const e={type:"Element",name:"root",children:[]},n=new Set,i=new Map;for(const[s,o]of t){if(n.has(s))continue;const t=o.values().next().value;if(!t)continue;const r={type:t.type,value:t.value,children:[]};"Element"===t.type&&(r.attributes={}),i.set(s,r),n.add(s),0===s&&e.children.push(r)}for(const[e,n]of t){const t=n.values().next().value;if(!t)continue;const s=i.get(e);if(s)for(const[e,n]of t.transitions){const t=i.get(n.equivalenceClass);t&&!s.children.includes(t)&&s.children.push(t)}}return{root:e,metadata:void 0}}computeMetadata(t){let e=0,n=0,i=0,s=0;const o=t=>{switch(e++,t.type){case"Element":n++;break;case"Text":i++;break;case"Comment":s++}t.children?.forEach(o)};return o(t),{nodeCount:e,elementCount:n,textCount:i,commentCount:s}}}class e{options;constructor(t={}){this.options={indent:t.indent??"  ",newLine:t.newLine??"\n",xmlDeclaration:t.xmlDeclaration??!0,prettyPrint:t.prettyPrint??!0}}generate(t){let e="";return this.options.xmlDeclaration&&(e+='<?xml version="1.0" encoding="UTF-8"?>'+this.options.newLine),e+=this.generateNode(t.root,0),e}generateNode(t,e){switch(t.type){case"Element":return this.generateElement(t,e);case"Text":return this.generateText(t,e);case"Comment":return this.generateComment(t,e);case"Doctype":return this.generateDoctype(t,e);default:throw new Error(`Unknown node type: ${t.type}`)}}generateElement(t,e){const n=this.options.prettyPrint?this.getIndent(e):"";let i=n+"<"+(t.name||"");if(t.attributes&&(i+=Object.entries(t.attributes).map((([t,e])=>` ${t}="${this.escapeAttribute(String(e))}"`)).join("")),!t.children?.length)return i+"/>"+this.options.newLine;if(i+=">",1===t.children.length&&"Text"===t.children[0].type)return i+=this.escapeText(t.children[0].value||""),i+="</"+t.name+">"+this.options.newLine,i;i+=this.options.newLine;for(const n of t.children)i+=this.generateNode(n,e+1);return i+=n+"</"+t.name+">"+this.options.newLine,i}generateText(t,e){return(this.options.prettyPrint?this.getIndent(e):"")+this.escapeText(t.value||"")+this.options.newLine}generateComment(t,e){return(this.options.prettyPrint?this.getIndent(e):"")+"\x3c!--"+(t.value||"")+"--\x3e"+this.options.newLine}generateDoctype(t,e){return(this.options.prettyPrint?this.getIndent(e):"")+"<!DOCTYPE "+(t.value||"")+">"+this.options.newLine}getIndent(t){return this.options.indent.repeat(t)}escapeText(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}escapeAttribute(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}}class n{tokens;position;constructor(t){this.tokens=t||[],this.position=0}setTokens(t){this.tokens=t,this.position=0}parse(){const t={type:"Element",name:"root",children:[]},e=[t];let n=t;for(;this.position<this.tokens.length;){const t=this.tokens[this.position++];switch(t.type){case"StartTag":const i={type:"Element",name:t.name,attributes:t.attributes,children:[]};n.children?.push(i),t.selfClosing||(e.push(i),n=i);break;case"EndTag":if(e.length>1){if(n.name!==t.name)throw new Error(`Mismatched tags: opening "${n.name}" and closing "${t.name}" at line ${t.location.line}, column ${t.location.column}`);e.pop(),n=e[e.length-1]}break;case"Text":case"Comment":case"Doctype":n.children?.push({type:t.type,value:t.value})}}if(e.length>1){const t=e[e.length-1];throw new Error(`Unclosed tag: ${t.name}`)}return{root:t,metadata:this.computeMetadata(t)}}computeMetadata(t){let e=0,n=0,i=0,s=0;return function t(o){e++,"Element"===o.type&&n++,"Text"===o.type&&i++,"Comment"===o.type&&s++,o.children?.forEach(t)}(t),{nodeCount:e,elementCount:n,textCount:i,commentCount:s}}}class i{input;position;line;column;constructor(t){this.input=t,this.position=0,this.line=1,this.column=1}peek(t=0){return this.input[this.position+t]||""}consume(){const t=this.peek();return"\n"===t?(this.line++,this.column=1):this.column++,this.position++,t}readUntil(t){let e="";for(;this.position<this.input.length&&!("string"==typeof t?this.peek()===t:t.test(this.peek()));)e+=this.consume();return e}skipWhitespace(){for(;/\s/.test(this.peek());)this.consume()}getCurrentLocation(){return{line:this.line,column:this.column}}}class s extends i{tokenize(){const t=[];for(;this.position<this.input.length;){const e=this.getCurrentLocation();if("<"===this.peek())if("!"===this.peek(1)){if(this.input.startsWith("\x3c!--",this.position)){const n=this.readComment();t.push({...n,location:e})}else if(this.input.startsWith("<!DOCTYPE",this.position)){const n=this.readDoctype();t.push({...n,location:e})}}else if("/"===this.peek(1)){const n=this.readEndTag();t.push({...n,location:e})}else{const n=this.readStartTag();t.push({...n,location:e})}else{const n=this.readText();n.value&&n.value.trim()&&t.push({...n,location:e})}}return t}readStartTag(){this.consume();const t=this.readUntil(/[\s\/>]/),e={};let n=!1;return this.readAttributes(e),this.skipWhitespace(),"/"===this.peek()&&(n=!0,this.consume()),this.consume(),{type:"StartTag",name:t,attributes:e,selfClosing:n,location:this.getCurrentLocation()}}readEndTag(){this.consume(),this.consume();const t=this.readUntil(/[\s>]/);return this.skipWhitespace(),this.consume(),{type:"EndTag",name:t,location:this.getCurrentLocation()}}readText(){return{type:"Text",value:this.readUntil("<"),location:this.getCurrentLocation()}}readComment(){this.consume(),this.consume(),this.consume(),this.consume();const t=this.readUntil("--\x3e");return this.consume(),this.consume(),this.consume(),{type:"Comment",value:t,location:this.getCurrentLocation()}}readDoctype(){this.consume(),this.consume(),this.readUntil(/\s/),this.skipWhitespace();const t=this.readUntil(">");return this.consume(),{type:"Doctype",value:t.trim(),location:this.getCurrentLocation()}}readAttributes(t){for(;this.position<this.input.length&&(this.skipWhitespace(),">"!==this.peek()&&"/"!==this.peek()&&void 0!==this.peek());){const e=this.readUntil(/[\s=>/]/);if(!e)break;let n="";if(this.skipWhitespace(),"="===this.peek()){this.consume(),this.skipWhitespace();const t=this.peek();'"'===t||"'"===t?(this.consume(),n=this.readUntil(t),this.consume()):n=this.readUntil(/[\s>]/)}else n="true";t[e]=n}}}class o{options;schema;constructor(t={}){this.options={strictMode:!1,allowUnknownElements:!0,schema:t.schema,customValidators:t.customValidators||[]},this.schema=t.schema}validate(t){const e=[];return this.schema&&this.validateNode(t.root,e,[]),this.options.customValidators.forEach((n=>{e.push(...n(t))})),{valid:0===e.length,errors:e}}validateNode(t,e,n){if("Element"!==t.type)return;const i=[...n,t.name||""];if(this.schema?.elements){const n=this.schema.elements[t.name||""];if(!n&&this.options.strictMode)return void e.push({code:"UNKNOWN_ELEMENT",message:`Unknown element: ${t.name}`,nodePath:i.join("/")});n&&(this.validateAttributes(t,n,e,i),this.validateChildren(t,n,e,i))}t.children?.forEach((t=>{this.validateNode(t,e,i)}))}validateAttributes(t,e,n,i){const s=t.attributes||{};e.required?.forEach((t=>{s[t]||n.push({code:"MISSING_REQUIRED_ATTRIBUTE",message:`Missing required attribute: ${t}`,nodePath:i.join("/")})})),this.options.strictMode&&e.attributes&&Object.keys(s).forEach((t=>{e.attributes?.includes(t)||n.push({code:"UNKNOWN_ATTRIBUTE",message:`Unknown attribute: ${t}`,nodePath:i.join("/")})}))}validateChildren(t,e,n,i){const s=(t.children||[]).filter((t=>"Element"===t.type));e.children&&s.forEach((t=>{"Element"!==t.type||e.children?.includes(t.name||"")||n.push({code:"INVALID_CHILD_ELEMENT",message:`Invalid child element: ${t.name}`,nodePath:i.join("/")})}))}}class r{tokenizer;parser;optimizer;generator;validator;options;constructor(i={}){this.options={validateOnParse:!1,optimizeAST:!0,...i},this.tokenizer=new s(""),this.parser=new n,this.optimizer=new t,this.generator=new e(i.generatorOptions),this.validator=new o(i.validationOptions)}parse(t){this.tokenizer=new s(t);const e=this.tokenizer.tokenize();this.parser.setTokens(e);let n=this.parser.parse();if(this.options.validateOnParse){const t=this.validator.validate(n);if(!t.valid)throw new Error(`XML Validation failed: ${JSON.stringify(t.errors)}`)}return this.options.optimizeAST&&(n=this.optimizer.optimize(n)),n}generate(t){return this.generator.generate(t)}validate(t){return this.validator.validate(t)}optimize(t){return this.optimizer.optimize(t)}}export{r as DOMXML,e as DOMXMLGenerator,t as DOMXMLOptimizer,n as DOMXMLParser,s as DOMXMLTokenizer,o as DOMXMLValidator,i as XMLBaseTokenizer};
//# sourceMappingURL=index.js.map
